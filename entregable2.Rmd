---
title: "PIE2 - Entregable 2"
author: "PauM PauF"
date: "2023-12-03"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)

irisdat4 <- read.csv2("C:/Users/paufe/Downloads/irisdat4.csv", stringsAsFactors=TRUE)
irisdat5 <- read.csv2("C:/Users/paufe/Downloads/irisdat5.csv", stringsAsFactors=TRUE)

library(wesanderson)
library(RColorBrewer)
```


# EXERCICI 1

**Es vol predir la longitud del sèpal de plantes de IRIS en funció de l’amplada del sèpal i de l’espècie
de IRIS. Llegiu les dades i contesteu les preguntes següents. **

## 1) Especifiqueu quina és la variable resposta i quines son les explicatives així com el tipus de variable del que es tracta.

La variable resposta és la longitut del sèpal i les variables explicatives són l'amplada del sèpal (variable numèrica) i l'espècie d'IRIS (variable categòrica).


## 2) Quines son les preguntes que té sentit contestar? 

Les preguntes que més ens interessaria contestar són:
  - 


## 3) Té sentit parlar d’interacció en aquest exercici?. Si és que sí, com l’interpretarieu?

Sí, ja que podria ser que entre diferents espèices d'IRIS la relació entre l'amplada del sèpal i la longitud del sèpal fos diferent, i aleshores hauriem de tenir en compte l'interacció entre les dues variables explicatives per a que el nostre model expliqui millor les dades.

--interpretació?


## 4) Dibuixeu de forma exploratòria el vostre conjunt de dades i en base al gràfic o gràfics realitzats, treieu unes primeres conclusions, especifiqueu-ne tres (caldrà comprovar-les més endavant).

```{r}
gplot <- ggplot(irisdat4) + 
  aes(y = Sepal.Length, x = Sepal.Width, color = Species) + 
  geom_point() + 
  geom_smooth(se = FALSE, method = "lm") + 
  theme_minimal()

# Canvi de colors dels punts segons l'espècie
gplot + scale_color_manual(values = wes_palette("GrandBudapest1", n = 3))
```

D'entrada s'observa que els tres pendents son molt similars, el que sembla indicar que la interacció entre les variables explicatives no és significativa (és a dir, que ...).

També es veu que les dades de l'espècie sectosa esta separada de les altres dues.



## 5) Ajusteu un model de regressió lineal simple i contestes les següents preguntes:

```{r}
model1 = lm(Sepal.Length ~ Sepal.Width, data=irisdat4)
summary(model1)

```

### 5.1) Quina és l'estimació de la veriància que heu obtingut?

L'estimació de la variança és $0.8251 ^2 = 0.68078$.

### 5.2) Quina part de la variabilitat de la variable resposta és explicada pel model?

Com que $R^2 = 0.007159$, aleshores el model descriu un 0.7159% de la variabilitat de la variable resposta en el model.

### 5.3) Quin és el residu més gran que heu trobat?

```{r}
max_res = irisdat4[ which.max(abs(residuals(model1))), ]
max_res = data.frame(max_res$Sepal.Length, max_res$Sepal.Width, max_res$Species)
max_res
```


El residu més gran és de 2.2226, que correspon a la mostra 132, amb valors Sepal length = 8.06 , Sepal width = 3.8 i Species=3, que correspon a l'espèice virginica.


### 5.4) Hi ha valors que tinguin un leverage superior al permès (feu servir la fita més acurada)? Quants?
```{r}

p = ncol(model.matrix(model1))
n = nrow(irisdat4)
cond_lev = 3*p/n
res = irisdat4[which(hatvalues(model1)>cond_lev),]
res = data.frame(res$X, res$Sepal.Length, res$Sepal.Width, res$Species)
res
```
Aquestes son les mostres que tenen un leverage superior al permès. 


### 5.5) Feu el plot dels residus i comenteu tres coses de les que considereu importants.

```{r, fig.align = 'center', out.width = "120%", fig.show="hold"}
par(mfrow = c(2,2))
plot(model1)

```

Podem veure que l'hipòtesis de normalitat de residus no s'acaba de complir, ja que a la gràfica de Residuals vs Fitted els errors no son del tot homogenis (son més grans al voltant del valor 6), i a l'extrem del qq-plot hi ha una mica de corbatura que no hi hauria de ser.
L'hipòtesis d'homodeasticitat tampoc es compleix del tot, ja que al plot de Scale-Location veiem que la desviació augmenta fins al valor 6 i després torna a disminuïr una mica.
I a la última gràfica veiem que no hi ha cap mostra que sigui molt influent (que tingui una Cook's distance gran). Dues que potser ho son més són les mostres 118 i 132.



## 6) Ajusteu un model que tingui com a explicatives les dues variables esmentades a l’enunciat i que no son la variable resposta (model 2).
```{r}
model2 = lm(Sepal.Length ~ Sepal.Width + Species, data=irisdat4)
summary(model2)
```

### 6.1) Quants paràmetres té el vostre model? Tots els paràmetres son significatius?
El model 2 té 4 paràmetres i tots són significatius.

### 6.2) Com interpreteu els paràmetres obtinguts? (una frase per a cada paràmetre).
L'espècie de referència d'aquest model és la setosa. Aleshores, els paràmetres els interpretem com:

Intercept: longitut del sèpal de l'espècie setosa quan l'amplada del sèpal és 0.
Sepal.Width: la longitut que augmenta el sèpal quan augmentem en una unitat la seva amplada.
Species versicolor: diferència de longitut del sèpal entre l'espècie setosa i versicolor.
Species virginica: diferència de longitut del sèpal entre l'espècie setosa i virginica.

### 6.3) Quina part de la variabilitat de les dades explica el vostre model?
Ara el model explica molt millor les dades que el model d'abans donat que $R^2 = 0.7203$ i, per tant, el model descriu un 72,03% de la variabilitat de les dades.

### 6.4) Quina és l’estimació de la variància residual que obteniu?
El residual standard error = 0.438, per tant, la  variància residual és $0.438^2 = 0.192$. 

### 6.5) Quina és la matriu del disseny (matriu X) associada al model que esteu ajustant?
```{r}
model.matrix(model2)
```



### 6.6) Feu els plots dels residus que creieu necessaris i treieu-ne tres conclusions que considereu importants.

```{r, fig.align = 'center', out.width = "120%", fig.show="hold"}
par(mfrow = c(2,2))
plot(model2)
```


### 6.7) Creieu que és necessàri treure alguna observació del conjunt de dades?. Justifiqueu la vostra resposta. En cas que sigui necessàri feu-ho i torneu a ajustar el model.
Si, potser convindria treure aquelles observacions que són més influents en el model, ja que por ser que siguin algún error en la presa de dades o que no formin part del mateix conjunt. Per tant, eliminarem aquelles mostres les quals tinguin un "leverage" superior a $3·p/n$.
Calculem doncs quines són aquestes mostres:

```{r}

p = ncol(model.matrix(model2))
n = nrow(irisdat4)
cond_lev = 3*p/n
res = irisdat4[which(hatvalues(model2)>cond_lev),]
res = data.frame(res$X, res$Sepal.Length, res$Sepal.Width, res$Species)
res
```
Com podem veure, la mostra número 42 és influent, per tant, provem a eliminar-la i ajustar de nou el model a veure que obtenim:

```{r}

irisdat42 <- irisdat4[-42, ]
model3 = lm(Sepal.Length ~ Sepal.Width + Species, data=irisdat42)
summary(model3)
```
No m'acaba de convèncer la opció d'abans... Vaig a provar eliminant els outliers del model que podem veure al qq-plot...

```{r}
irisdat43 <- irisdat4[- c(119,123,107), ]
model4 = lm(Sepal.Length ~ Sepal.Width + Species, data=irisdat43)
summary(model4)
par(mfrow = c(2,2))
plot(model4)
```
A veure, sembla que així està millor d'aquesta manera ens surt un R^2 més bo i un Residual standard error menor, tot i que en la gràfica de residuals vs fitted ara ens dona pitjor que abans, jo crec que potser no cal eliminar cap dada, ens hem d'acabar de mirar això bé però...


## 7) Amb el conjunt de dades que us hagiu quedat al final de l’apartat 6), ajusteu un model que assumeixi que les dues variables explicatives del model 2 interaccionen (model3).
### 7.1) Us surt significativa la interacció?
### 7.2) Quina és l’estimació de la variància residual?
### 7.3) Interpreteu els paràmetres que us surtin significatius (una frase per a cada paràmetre).
### 7.4) Han millorat els gràfics de residus respecte als trobats amb el model 2? Justifiqueu la vostra resposta.
## 9) Feu una taula comparativa dels tres models ajustats i que us permeti decidir quin dels tres és el millor. Justifiqueu en paraules la vostra elecció.
## 10) Pel model escollit, prediu quina és la longitud esperada d’un sèpal que tingui una amplada de 38:00 per a cadascúna de les espècies que tenim. Expliciteu tant l’estimació puntual com l’intèrval de confiança al 95%.
